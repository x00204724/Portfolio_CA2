<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Annit's Portfolio</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body data-bs-theme="dark">

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header text-center">
                    <h3 id="form-title">Sign In</h3>
                </div>
                <div class="card-body">
                    <form id="authForm">
                        <div class="mb-3">
                            <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="email" required>
                            <div class="invalid-feedback">Please enter a valid email address.</div>
                        </div>
                        
                        <div class="mb-3" id="username-field" style="display: none;">
                            <label for="username" class="form-label">Username <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="username" minlength="3">
                            <div class="invalid-feedback">Username must be at least 3 characters long.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="password" class="form-label">Password <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" id="password" required>
                            <div class="invalid-feedback" id="password-feedback">Password is required.</div>
                            <div class="form-text" id="password-requirements" style="display: none;">
                                Password must contain:
                                <ul class="mt-2">
                                    <li id="length-req" class="text-danger">At least 8 characters</li>
                                    <li id="upper-req" class="text-danger">One uppercase letter</li>
                                    <li id="lower-req" class="text-danger">One lowercase letter</li>
                                    <li id="number-req" class="text-danger">One number</li>
                                    <li id="special-req" class="text-danger">One special character (!@#$%^&*)</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="mb-3" id="confirm-password-field" style="display: none;">
                            <label for="confirmPassword" class="form-label">Confirm Password <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" id="confirmPassword">
                            <div class="invalid-feedback">Passwords do not match.</div>
                        </div>
                        
                        <div class="mb-3" id="captcha-field">
                            <label for="captcha" class="form-label">CAPTCHA <span class="text-danger">*</span></label>
                            <div class="d-flex align-items-center mb-2">
                                <span id="captcha-question" class="me-3 p-2 bg-secondary rounded"></span>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="generateCaptcha()">ðŸ”„</button>
                            </div>
                            <input type="text" class="form-control" id="captcha" required placeholder="Enter the answer">
                            <div class="invalid-feedback">Please solve the CAPTCHA correctly.</div>
                        </div>
                        
                        <div class="mb-3 form-check" id="save-password-field" style="display: none;">
                            <input type="checkbox" class="form-check-input" id="savePassword">
                            <label class="form-check-label" for="savePassword">Save password for next time</label>
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100" id="submit-btn">Sign In</button>
                    </form>
                    
                    <div class="text-center mt-3">
                        <button type="button" class="btn btn-link" id="toggle-btn">Don't have an account? Register here</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
let isRegistering = false;
let captchaAnswer = 0;

function generateCaptcha() {
    const num1 = Math.floor(Math.random() * 10) + 1;
    const num2 = Math.floor(Math.random() * 10) + 1;
    const operations = ['+', '-', '*'];
    const operation = operations[Math.floor(Math.random() * operations.length)];
    
    let question, answer;
    switch(operation) {
        case '+':
            question = `${num1} + ${num2} = ?`;
            answer = num1 + num2;
            break;
        case '-':
            question = `${num1} - ${num2} = ?`;
            answer = num1 - num2;
            break;
        case '*':
            question = `${num1} Ã— ${num2} = ?`;
            answer = num1 * num2;
            break;
    }
    
    document.getElementById('captcha-question').textContent = question;
    captchaAnswer = answer;
    document.getElementById('captcha').value = '';
}

window.onload = function() {
    generateCaptcha();
    loadSavedCredentials();
};

function loadSavedCredentials() {
    const savedEmail = localStorage.getItem('savedEmail');
    const savedPassword = localStorage.getItem('savedPassword');
    
    if (savedEmail && savedPassword) {
        document.getElementById('email').value = savedEmail;
        document.getElementById('password').value = savedPassword;
    }
}

document.getElementById('toggle-btn').addEventListener('click', function() {
    toggleForm();
});

document.getElementById('authForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (isRegistering) {
        if (validateRegistration()) {
            registerUser();
        }
    } else {
        if (validateLogin()) {
            loginUser();
        }
    }
});

function toggleForm() {
    isRegistering = !isRegistering;
    
    if (isRegistering) {
        document.getElementById('form-title').textContent = 'Register';
        document.getElementById('submit-btn').textContent = 'Register';
        document.getElementById('toggle-btn').textContent = 'Already have an account? Sign in here';
        document.getElementById('username-field').style.display = 'block';
        document.getElementById('confirm-password-field').style.display = 'block';
        document.getElementById('password-requirements').style.display = 'block';
        document.getElementById('save-password-field').style.display = 'block';
        document.getElementById('username').required = true;
        document.getElementById('confirmPassword').required = true;
    } else {
        document.getElementById('form-title').textContent = 'Sign In';
        document.getElementById('submit-btn').textContent = 'Sign In';
        document.getElementById('toggle-btn').textContent = "Don't have an account? Register here";
        document.getElementById('username-field').style.display = 'none';
        document.getElementById('confirm-password-field').style.display = 'none';
        document.getElementById('password-requirements').style.display = 'none';
        document.getElementById('save-password-field').style.display = 'none';
        document.getElementById('username').required = false;
        document.getElementById('confirmPassword').required = false;
    }
    
    document.getElementById('authForm').reset();
    generateCaptcha();
}

function registerUser() {
    const email = document.getElementById('email').value;
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    const savePassword = document.getElementById('savePassword').checked;
    
    const userData = {
        email: email,
        username: username,
        password: password,
        registrationDate: new Date().toISOString(),
        isNewUser: true
    };
    
    localStorage.setItem('user_' + email, JSON.stringify(userData));
    
    if (savePassword) {
        localStorage.setItem('savedEmail', email);
        localStorage.setItem('savedPassword', password);
    }
    
    alert('Welcome ' + username + '! Registration successful as a NEW USER. Logging you in automatically...');
    
    sessionStorage.setItem('currentUser', JSON.stringify(userData));
    window.location.href = 'index.html';
}

function loginUser() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    
    const storedUser = localStorage.getItem('user_' + email);
    
    if (storedUser) {
        const userData = JSON.parse(storedUser);
        
        if (userData.password === password) {
            const registrationDate = new Date(userData.registrationDate);
            const daysSinceRegistration = (new Date() - registrationDate) / (1000 * 60 * 60 * 24);
            
            if (daysSinceRegistration <= 7) {
                alert('Welcome back ' + userData.username + '! You are a NEW USER (registered ' + Math.floor(daysSinceRegistration) + ' days ago).');
            } else {
                alert('Welcome back ' + userData.username + '! You are a RETURNING USER (member since ' + registrationDate.toDateString() + ').');
            }
            
            sessionStorage.setItem('currentUser', JSON.stringify(userData));
            window.location.href = 'index.html';
        } else {
            alert('Incorrect password for existing user.');
        }
    } else {
        alert('No account found with this email. Please register first.');
    }
}

function validateLogin() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const captchaInput = parseInt(document.getElementById('captcha').value);
    
    if (captchaInput !== captchaAnswer) {
        alert('CAPTCHA answer is incorrect. Please try again.');
        generateCaptcha();
        return false;
    }
    
    return email.includes('@') && password.length > 0;
}

function validateRegistration() {
    const email = document.getElementById('email').value;
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const captchaInput = parseInt(document.getElementById('captcha').value);
    
    if (captchaInput !== captchaAnswer) {
        alert('CAPTCHA answer is incorrect. Please try again.');
        generateCaptcha();
        return false;
    }
    
    if (localStorage.getItem('user_' + email)) {
        alert('An account with this email already exists. Please sign in instead.');
        return false;
    }
    
    if (!email.includes('@')) {
        alert('Please enter a valid email address.');
        return false;
    }
    
    if (username.length < 3) {
        alert('Username must be at least 3 characters long.');
        return false;
    }
    
    const passwordValid = password.length >= 8 && 
                         /[A-Z]/.test(password) && 
                         /[a-z]/.test(password) && 
                         /[0-9]/.test(password) && 
                         /[!@#$%^&*]/.test(password);
    
    if (!passwordValid) {
        alert('Password must contain at least 8 characters, one uppercase letter, one lowercase letter, one number, and one special character (!@#$%^&*).');
        return false;
    }
    
    if (password !== confirmPassword) {
        alert('Passwords do not match.');
        return false;
    }
    
    return true;
}
</script>

</body>
</html>